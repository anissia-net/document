# 애니메이션 순위
- 이 문서는 애니시아의 애니메이션 순위 집계 기준에 대한 문서이다.

## 공통사항
- ### 수집방법
  - **애니메이션 편성표**에서 애니메이션을 클릭한 경우.
  - 애니시아의 **애니 정보** 매뉴에서 애니메이션을 클릭한 경우.
- ### 수집항목
  |항목|예제|설명|
  |-|-|-|
  |애니메이션 고유번호|1234|-|
  |IP 주소|1.1.1.1| **개인정보 해당, 아래 수집기간 참고** |
  |시간|2020011608|yyyyMMddHH|
- ### 수집기간
  - 합산완료시 까지
    - 매 시간의 1분에 작동 : ex) 00:01, 01:01... 23:01
      - 아래 **애니메이션 순위 합산 스케줄링** 에서 소스코드 확인가능
    - 합산이 완료되면 합산에 계산되었던 위 수집항목 (**IP 주소**) 가 삭제된다.
      - 참고의 **애니메이션 순위 구현 메인코드** 의 animeHitRepository.deleteByHourLessThan() 에 해당
- ### 합산방법
  - 시간별(00, 01.. 23) IP 중복이 제거된 로그를 합산한다.
    - 예를들어 다음과 같이 클릭 했을때 **애니A (1회)**, **애니B (3회)** 가 된다. 
    
        |시간|IP 주소|애니메이션|유효여부|기타|
        |-|-|-|-|-|
        |02:00|1.1.1.1|애니A|O|-|
        |02:31|1.1.1.1|애니A|X|IP 중복|
        |02:59|1.1.1.1|애니A|X|IP 중복|
        |02:59|1.1.1.1|애니B|O|-|
        |03:00|1.1.1.1|애니B|O|IP 는 중복되나 시간[02 != 03]이 다름|
        |02:00|2.2.2.2|애니B|O|-|

## 집계 기준
- 가독성을 위해 **일**로 표기했지만, 실제단위는 **시** (1일 = 24시간) 이다.

  |기간|집계 기준|순위 변동 비교 기준|
  |-|-|-|
  |~~일간 (삭제됨)~~|~~최근 1일~~|~~최근 7일~~|
  |주간|최근 7일|최근 14일|
  |~~월간 (삭제됨)~~|~~최근 28일~~|~~최근 35일~~|
  |분기|최근 84일|최근 112일|
  |연간|최근 364일|최근 392일|
- 월간 기준이 28일인 이유는 **애니편성표** 가 통계의 큰 비중을 차지하는데, 애니의 반영주기가 7일 이기 때문이다.
  - 때문에 _7로 나누어 떨어질 수 있는 28일_ 을 기준으로 잡았다.
  - 30일을 기준으로 잡을경우, 예를들어 **화요일** 에 집계를 한다면 아래와 같은 문제가 발생한다.
    - **월/화**는 최근 **5주**, **수/목/금/토/일** 은 최근 **4주** 를 합산하게 된다.
- **일간** 집계가 있었으나 애니편성표의 **요일** 기준으로 매일 전체 순위가 바뀌는 현상 때문에 **일간**을 제외하고 **분기**를 추가하였다.
    - 마찬가지로 분기도 91.25일이 아닌 84일을 기준으로 한다.
    
## 참고
- [애니메이션 순위 구현 메인코드](https://github.com/anissia-net/core/blob/master/src/main/kotlin/anissia/domain/anime/core/service/UpdateAnimeRankService.kt)
- [애니메이션 순위 합산 스케줄링](https://github.com/anissia-net/core/blob/master/src/main/kotlin/anissia/infrastructure/configuration/ScheduleConfiguration.kt)
